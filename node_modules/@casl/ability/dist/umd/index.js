(function(t,r){"object"===typeof exports&&"undefined"!==typeof module?r(exports,require("@ucast/mongo2js")):"function"===typeof define&&define.amd?define(["exports","@ucast/mongo2js"],r):(t="undefined"!==typeof globalThis?globalThis:t||self,r(t.casl={},t.ucast.mongo2js))})(this,(function(t,r){"use strict";function i(t,r){for(var i=0;i<r.length;i++){var n=r[i];n.enumerable=n.enumerable||false;n.configurable=true;if("value"in n)n.writable=true;Object.defineProperty(t,n.key,n)}}function n(t,r,n){if(r)i(t.prototype,r);if(n)i(t,n);return t}function e(){e=Object.assign||function(t){for(var r=1;r<arguments.length;r++){var i=arguments[r];for(var n in i)if(Object.prototype.hasOwnProperty.call(i,n))t[n]=i[n]}return t};return e.apply(this,arguments)}function o(t,r){t.prototype=Object.create(r.prototype);t.prototype.constructor=t;t.__proto__=r}function u(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function s(t){return Array.isArray(t)?t:[t]}var f="__caslSubjectType__";function a(t,r){if(r)if(!r.hasOwnProperty(f))Object.defineProperty(r,f,{value:t});else if(t!==r[f])throw new Error("Trying to cast object to subject type "+t+" but previously it was casted to "+r[f]);return r}var c=function t(r){var i=typeof r;return"string"===i||"function"===i};var h=function t(r){return r.modelName||r.name};var v=function t(r){return"string"===typeof r?r:h(r)};function l(t){if(!t)return"all";if(t.hasOwnProperty(f))return t[f];return h(t.constructor)}function d(t,r){var i=s(r);var n=0;while(n<i.length){var e=i[n++];if(t.hasOwnProperty(e))i=i.concat(t[e])}return i}function b(t){if(t.manage)throw new Error('Cannot add alias for "manage" action because it is reserved');Object.keys(t).forEach((function(r){var i=r===t[r]||Array.isArray(t[r])&&(-1!==t[r].indexOf(r)||-1!==t[r].indexOf("manage"));if(i)throw new Error("Attempt to alias action to itself: "+r+" -> "+t[r])}))}function p(t){if("production"!==process.env.NODE_ENV)b(t);return function(r){return d(t,r)}}function y(t,r,i){for(var n=i;n<r.length;n++)t.push(r[n])}function w(t,r){if(!t||!t.length)return r||[];if(!r||!r.length)return t||[];var i=0;var n=0;var e=[];while(i<t.length&&n<r.length)if(t[i].priority<r[n].priority){e.push(t[i]);i++}else{e.push(r[n]);n++}y(e,t,i);y(e,r,n);return e}function g(t,r,i){var n=t.get(r);if(!n){n=i();t.set(r,n)}return n}var E=function t(r){return r};function A(t,r){if(Array.isArray(t.fields)&&!t.fields.length)throw new Error("`rawRule.fields` cannot be an empty array. https://bit.ly/390miLa");if(t.fields&&!r.fieldMatcher)throw new Error('You need to pass "fieldMatcher" option in order to restrict access by fields');if(t.conditions&&!r.conditionsMatcher)throw new Error('You need to pass "conditionsMatcher" option in order to restrict access by conditions')}var $=function(){function t(t,r,i){if(void 0===i)i=0;A(t,r);this.action=r.resolveAction(t.action);this.subject=t.subject;this.inverted=!!t.inverted;this.conditions=t.conditions;this.reason=t.reason;this.fields=t.fields?s(t.fields):void 0;this.priority=i;this.t=r}var r=t.prototype;r.i=function t(){if(this.conditions&&!this.o)this.o=this.t.conditionsMatcher(this.conditions);return this.o};r.matchesConditions=function t(r){if(!this.conditions)return true;if(!r||c(r))return!this.inverted;var i=this.i();return i(r)};r.matchesField=function t(r){if(!this.fields)return true;if(!r)return!this.inverted;if(this.fields&&!this.u)this.u=this.t.fieldMatcher(this.fields);return this.u(r)};n(t,[{key:"ast",get:function t(){var r=this.i();return r?r.ast:void 0}}]);return t}();var m=function t(r,i){var n={value:r,prev:i,next:null};if(i)i.next=n;return n};var j=function t(r){if(r.next)r.next.prev=r.prev;if(r.prev)r.prev.next=r.next;r.next=r.prev=null};var M=function t(){return{rules:[],merged:false}};var x=function t(){return new Map};var F=function t(r,i){if(!r.h&&i.fields)r.h=true};var O=function(){function t(t,r){if(void 0===t)t=[];if(void 0===r)r={};this.h=false;this.v=new Map;this.l={conditionsMatcher:r.conditionsMatcher,fieldMatcher:r.fieldMatcher,resolveAction:r.resolveAction||E};this.p=r.detectSubjectType||l;this.g=t;this.A=this.$(t)}var r=t.prototype;r.detectSubjectType=function t(r){return c(r)?r:this.p(r)};r.update=function t(r){var i={rules:r,ability:this,target:this};this.m("update",i);this.g=r;this.A=this.$(r);this.m("updated",i);return this};r.$=function t(r){var i=new Map;for(var n=r.length-1;n>=0;n--){var e=r.length-n-1;var o=new $(r[n],this.l,e);var u=s(o.action);var f=s(o.subject||"all");F(this,o);for(var a=0;a<f.length;a++){var c=g(i,f[a],x);for(var h=0;h<u.length;h++)g(c,u[h],M).rules.push(o)}}return i};r.possibleRulesFor=function t(r,i){if(void 0===i)i="all";if(!c(i))throw new Error('"possibleRulesFor" accepts only subject types (i.e., string or class) as the 2nd parameter');var n=g(this.A,i,x);var e=g(n,r,M);if(e.merged)return e.rules;var o="manage"!==r&&n.has("manage")?n.get("manage").rules:void 0;var u=w(e.rules,o);if("all"!==i)u=w(u,this.possibleRulesFor(r,"all"));e.rules=u;e.merged=true;return u};r.rulesFor=function t(r,i,n){var e=this.possibleRulesFor(r,i);if(n&&"string"!==typeof n)throw new Error("The 3rd, `field` parameter is expected to be a string. See https://stalniy.github.io/casl/en/api/casl-ability#can-of-pure-ability for details");if(!this.h)return e;return e.filter((function(t){return t.matchesField(n)}))};r.on=function t(r,i){var n=this;var e=this.v.get(r)||null;var o=m(i,e);this.v.set(r,o);return function(){if(!o.next&&!o.prev&&n.v.get(r)===o)n.v.delete(r);else j(o)}};r.m=function t(r,i){var n=this.v.get(r)||null;while(null!==n){var e=n.prev;n.value(i);n=e}};n(t,[{key:"rules",get:function t(){return this.g}}]);return t}();var _=function(t){o(PureAbility,t);function PureAbility(){return t.apply(this,arguments)||this}var r=PureAbility.prototype;r.can=function t(){var r=this.relevantRuleFor.apply(this,arguments);return!!r&&!r.inverted};r.relevantRuleFor=function t(r,i,n){var e=this.detectSubjectType(i);var o=this.rulesFor(r,e,n);for(var u=0,s=o.length;u<s;u++)if(o[u].matchesConditions(i))return o[u];return null};r.cannot=function t(){return!this.can.apply(this,arguments)};return PureAbility}(O);var T={$eq:r.$eq,$ne:r.$ne,$lt:r.$lt,$lte:r.$lte,$gt:r.$gt,$gte:r.$gte,$in:r.$in,$nin:r.$nin,$all:r.$all,$size:r.$size,$regex:r.$regex,$options:r.$options,$elemMatch:r.$elemMatch,$exists:r.$exists};var P={eq:r.eq,ne:r.ne,lt:r.lt,lte:r.lte,gt:r.gt,gte:r.gte,in:r.within,nin:r.nin,all:r.all,size:r.size,regex:r.regex,elemMatch:r.elemMatch,exists:r.exists,and:r.and};var R=function t(i,n,o){return r.createFactory(e({},T,i),e({},P,n),o)};var q=r.createFactory(T,P);var B=/[-/\\^$+?.()|[\]{}]/g;var k=/\.?\*+\.?/g;var z=/\*+/;var C=/\./g;function S(t,r,i){var n="*"===i[0]||"."===t[0]&&"."===t[t.length-1]?"+":"*";var e=-1===t.indexOf("**")?"[^.]":".";var o=t.replace(C,"\\$&").replace(z,e+n);return r+t.length===i.length?"(?:"+o+")?":o}function Y(t,r,i){if("."===t&&("*"===i[r-1]||"*"===i[r+1]))return t;return"\\"+t}function L(t){var r=t.map((function(t){return t.replace(B,Y).replace(k,S)}));var i=r.length>1?"(?:"+r.join("|")+")":r[0];return new RegExp("^"+i+"$")}var D=function t(r){var i;return function(t){if("undefined"===typeof i)i=r.every((function(t){return-1===t.indexOf("*")}))?null:L(r);return null===i?-1!==r.indexOf(t):i.test(t)}};var G=function(t){o(Ability,t);function Ability(r,i){if(void 0===r)r=[];if(void 0===i)i={};return t.call(this,r,e({conditionsMatcher:q,fieldMatcher:D},i))||this}return Ability}(_);var H=function(){function t(t){this.j=t}var r=t.prototype;r.because=function t(r){this.j.reason=r;return this};return t}();var I=function(){function AbilityBuilder(t){this.rules=[];this.M=t;this.can=this.can.bind(this);this.cannot=this.cannot.bind(this);this.build=this.build.bind(this)}var t=AbilityBuilder.prototype;t.can=function t(r,i,n,e){var o={action:r};if(i){o.subject=i;if(Array.isArray(n)||"string"===typeof n)o.fields=n;else if("undefined"!==typeof n)o.conditions=n;if("undefined"!==typeof e)o.conditions=e}this.rules.push(o);return new H(o)};t.cannot=function t(r,i,n,e){var o=this.can(r,i,n,e);o.j.inverted=true;return o};t.build=function t(r){return new this.M(this.rules,r)};return AbilityBuilder}();function defineAbility(t,r){var i=new I(G);var n=t(i.can,i.cannot);if(n&&"function"===typeof n.then)return n.then((function(){return i.build(r)}));return i.build(r)}var J=function t(r){return'Cannot execute "'+r.action+'" on "'+r.subjectType+'"'};var K=function t(r){this.message=r};K.prototype=Object.create(Error.prototype);var N=function(t){o(ForbiddenError,t);ForbiddenError.setDefaultMessage=function t(r){this.F="string"===typeof r?function(){return r}:r};ForbiddenError.from=function t(r){return new this(r)};function ForbiddenError(r){var i;i=t.call(this,"")||this;i.ability=r;if("function"===typeof Error.captureStackTrace){i.name="ForbiddenError";Error.captureStackTrace(u(i),i.constructor)}return i}var r=ForbiddenError.prototype;r.setMessage=function t(r){this.message=r;return this};r.throwUnlessCan=function t(){var r;var i=(r=this.ability).relevantRuleFor.apply(r,arguments);if(i&&!i.inverted)return;this.action=arguments.length<=0?void 0:arguments[0];this.subject=arguments.length<=1?void 0:arguments[1];this.subjectType=v(this.ability.detectSubjectType(arguments.length<=1?void 0:arguments[1]));this.field=arguments.length<=2?void 0:arguments[2];var n=i?i.reason:"";this.message=this.message||n||this.constructor.F(this);throw this};return ForbiddenError}(K);N.F=J;t.Ability=G;t.AbilityBuilder=I;t.ForbiddenError=N;t.PureAbility=_;t.buildMongoQueryMatcher=R;t.createAliasResolver=p;t.defineAbility=defineAbility;t.detectSubjectType=l;t.fieldPatternMatcher=D;t.getDefaultErrorMessage=J;t.mongoQueryMatcher=q;t.subject=a;t.wrapArray=s;Object.defineProperty(t,"__esModule",{value:true})}));
//# sourceMappingURL=index.js.map
